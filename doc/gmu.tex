\documentclass[11pt,a4paper]{article}
\input{config}

\begin{document}
\titlepageandcontents

%---------------------------------------------------------------------------
\section{Zadání}

Cílem projektu je urychlení jednoduché fyzikální simulace s~využitím výpočetního
výkonu grafické karty.

\begin{description}
  \item[Kolize jednoduchých geometrických těles] ~ \\
    Není třeba vytvářet komplexní fyzikální simulaci.
    Kolize mezi kvádry jsou zcela postačující.
  \item[Jednoduchá scéna] ~ \\
    Cílem nejsou kolize s členitým terénem. Scénu není třeba komplikovat.
    Jeden větší statický box může sloužit jako země. Další boxy budou
    naskládány do většího uskupení a umístěny kousek nad tímto boxem.
    Po spuštění programu boxy spadnou a uskupení se rozpadne.
\end{description}

%---------------------------------------------------------------------------
\section{Použité technologie}

\begin{description}
  \item[OpenCL] ~ \\
    OpenCL slouží k~paralelizaci / urychlení algoritmu fyzikální simulace.
  \item[OpenGL] ~ \\
    OpenGL slouží k~vykreslení scény.
  \item[CMake] ~ \\
    Multiplatformní systém pro sestavení knihoven a spustitelných souborů.
  \item[OpenCLUtilities] ~ \\
    Velice jednoduchá knihovna zapouzdřující práci s~OpenCL. Poskytuje relativně
    malý seznam funkcionality, ale pro účely tohoto projektu postačuje.
    (\url{https://github.com/smistad/OpenCLUtilities})
  \item[SDL2] ~ \\
    Multiplatformní knihovna pro práci s~vstupními a výstupními zařízení.
    V~projektu je využitá pro zpracování vstupu z~klávesnice a myši a vytvoření
    vykreslovacího okna.
  \item[glew] ~ \\
    Multiplatformní knihovna sloužicí k~dynamickému linkování OpenGL funkcionality
    za běhu aplikace.
\end{description}

%---------------------------------------------------------------------------
\section{Použité zdroje}

\begin{description}
  \item[Game Physics Engine Development - Ian Millington] ~ \\
    Celkem rozsáhlá kniha popisující základy potřebné pro implementaci
    jednoduchého fyzikálního enginu.
  \item[qu3e] ~ \\
    Jednoduchý 3D fyzikální engine psaný v~C++. Podporuje pouze kolize
    s~boxy. (\url{https://github.com/RandyGaul/qu3e})
    Tuto knihovnu jsem použil jako základ pro tento projekt, protože
    implementace byť i jednoduché fyzikální knihovny by mi pravděpodobně
    zabrala příliš mnoho času. Proto jsem se rozhodl upravit tuto knihovnu
    a přidat do ní výpočet s~využitím OpenCL.
\end{description}

%---------------------------------------------------------------------------
\section{Nejdůležitější dosažené výsledky}

\begin{description}
  \item[Podobné chování] ~ \\
    Výsledek simulace je na CPU a na GPU podobný. Ačkoli při podrobnějším zkoumání
    lze najít rozdíly, není vyžadována fyzikálně přesná simulace, takže to nevadí.
  \item[Bylo dosaženo zrychlení] ~ \\
    Při vysokém počtu kolizí v~rámci jednoho shluku je oproti původní CPU
    implementaci dosaženo jistého zrychlení, které závisí na velikosti
    shluku a počtu iterací použitých pro řešení kolizí.
\end{description}

%---------------------------------------------------------------------------
\section{Ovládání vytvořeného programu}

Následujícími parametry lze nastavit OpenCL akceleraci:

\begin{description}
  \item[\texttt{--none}] ~ \\
    Program nepoužije OpenCL akceleraci (výchozí)
  \item[\texttt{--cpu}] ~ \\
    Program použije OpenCL akceleraci na CPU
  \item[\texttt{--gpu}] ~ \\
    Program použije OpenCL akceleraci na GPU
\end{description}

Program se ovládá klávesami \texttt{W}, \texttt{A}, \texttt{S}, \texttt{D}
pro pohyb závislý na směru kamery, klávesy \texttt{SHIFT} a \texttt{CTRL}
slouží pro vertikální posun.

Primárním tlačítkem myši pak lze kamerou rotovat.

%---------------------------------------------------------------------------
\section{Zvláštní použité znalosti}

Přiliš si neuvědomuji použití nějakých zvláštních znalostí.

%---------------------------------------------------------------------------
\section{Rozdělení práce v týmu}

Na projektu jsem pracoval sám.

%---------------------------------------------------------------------------
\section{Co bylo nejpracnější}

\paragraph{Nejpracnější bylo začít}

Ačkoliv jsem přečetl celou knihu \textbf{Game Physics Engine Development} a
několik dalších publikací, měl jsem vážný problém začít s~implementací.
Jednak jsem se nemohl rozhodnout jakou metodu simulace použiju,
a u~téměř u~všech jsem měl pocit, že nemám dostatek informací a s~množstvím
času které mám bych to nestihl. Až jsem pak našel knihovnu \textbf{qu3e}, která
byla paralelizovatelná bez nutnosti příliš velkých změn.

\paragraph{OpenCL a Linux}

Jedním z~prvních technických problémů, které jsem řešil bylo zprovoznění OpenCL
na mém notebooku. Ten disponuje technologií Optimus pro přepínání mezi
integrovanou grafikou Intel a dedikovanou grafikou nVidia.
Ačkoliv ovladače od nVidie jsou na linuxu celkově v~dobrém stavu, přepínání
není zatím dobře vyřešeno a~spuštění OpenCL na grafice bylo poněkud složitější.

\paragraph{Zarovnání dat}

Dlouho jsem se trápil se správným zarovnáním datových struktur v~knihovně
\textbf{qu3e} aby bylo možné je přímo nahrát do OpenCL bufferu.
Občas jsem měl dokonce problém s~různou velikostí stejného typu v~rámci programu
z~důvodu podmíněného kódu v~hlavičce.

%---------------------------------------------------------------------------
\section{Zkušenosti získané řešením projektu}

V~první řadě jsem pořádně si vyzkoušel OpenCL, před tím jsem měl zkušenosti pouze
s~OpenGL a compute shadery. Nejdůležitější získanou zkušeností pro mě
bylo asi již dříve zmíněné zarovnání dat.

Dále jsem se blíže seznámil se sestavovacím systémem \textbf{CMake}.
Někdy jsem se sice vztekal nad netransparentností toho systému, ale
u~větších projektů to bude asi lepší než psát Makefiles.

V~poslední řadě jsem si přiblížil některé principy fyzikální simulace.
Jak to celé zhruba funguje a co se dá jakým způsobem urychlit.

%---------------------------------------------------------------------------
\section{Autoevaluace}

\paragraph{Technický návrh (60\%):}

Použití knihovny \textbf{qu3e} znatelně snížilo množství času, který bych musel
nad projektem strávit. V~této knihovně jsem pak našel kód, který je pro
paralelizaci téměř ideální.

\paragraph{Programování (75\%):}

Jako základ jsem použil kostru, kterou jsem si vytvořil v~rámci projektu do
předmětu PGP (v adresáři \texttt{src/}).
Většina práce jsou však úpravy v~knihovně \textbf{qu3e}.
Některé způsoby jakými jsem dostal potřebnou funkcionalitu na správné místo
možná nejsou ideální a občas se mi ve zdrojových kódech knihovny míchaly tabulátory
a mezery.

\paragraph{Vzhled vytvořeného řešení (60\%):}

Aplikace je založena na jednom demu knihovny \textbf{qu3e}.
Pro jednodušší rozlišení boxů jsem přidal různí barvy, jinak aplikace
neobsahuje žádné grafické rozhraní.

\paragraph{Využití zdrojů (85\%):}

Přečetl jsem relativně velké množství literatury, ovšem prakticky jsem
nabyté znalosti v~programu příliš neuplatnil.
Naopak hodně jsem využil již dostupné zdrojové kódy, zejména pak
knihovnu \textbf{qu3e} a část kódu napsaného v~rámci projektu do PGP.

\paragraph{Hospodaření s časem (20\%):}

Na projektu jsem začal velice pozdě (nejen na tomto projektu) a celkové jsem
příliš nestíhal. Ačkoliv bych věděl co je třeba udělat pro další zrychlení,
nezbývá mi na implementaci čas.

\paragraph{Spolupráce v týmu (0\%):}

Na projektu jsem pracoval sám.

\paragraph{Celkový dojem (70\%):}

Projekt byl velice pracný. Pracoval jsem na něm sám a ještě jsem začal pozdě,
což nebylo příliš ideální vzhledem k~rozsáhlosti a složitosti problematiky
fyzikální simulace. Nicméně si myslím, že jsem při řešení problému postupoval
správným směrem. Aktuální implementace sice vykazuje určité zrychlení, ale
pouze v~určitých případech. V~opačném případě dokonce dochází ke zpomalení
které je způsobeno způsobem, jakým je v~knihovně \textbf{qu3e} simulace řešena.
Pro odstranění tohoto zpomalení je ještě třeba provést o~něco výraznější změny
ve struktuře knihovny.

Ačkoliv projekt v~aktuálním stavu není příliš použitelný, nabyté znalosti
(a možná i~kód) mohu použít ve své diplomové práci. Hlavně zkušenosti s~OpenCL.
A~projekt pro mě určitě užitečným byl.

%---------------------------------------------------------------------------
\section{Doporučení pro budoucí zadávání projektů}

Jednoduchost a~relativní volnost zadání je určitě plusem.
Jako lehce negativní vnímám rozsáhlost projektu, ale pro tým 3 lidí by to bylo
asi akorát.

%---------------------------------------------------------------------------
\section{Různé}

V~dokumentaci zcela chybí sekce pro popis implementace a paralelizace vybraných
algoritmů. Takže je popíši v~následujících sekcích.

\subsection{Princip enginu \textit{qu3e}}

\textbf{qu3e} používá pro simulaci pouze orientované boxy. Umožňuje vytvořit
tělěso složené s~více boxů, ale touto funkcionalitou jsem se nezabýval.

Výpočet kolizí probíhá ve více fázích. Každý box disponuje obalovým tělesem
(AABB - Axis Aligned Bounding Box), a nad těmito tělesy je vytvořena hierarchie
obalových těles (BVH - Bounding Volume Hierarchy). Tyto struktury značně
urychlují detekci kolizí, protože jednoduchými algoritmy vyfiltrují páry
těles, mezi kterými jednoznačně kolize nejsou.

Mezi páry těles, které prošly hrubou fází se pak zjištují kolize přesněji pomocí
algotitmu SAP (Separating Axis Theorem). Pokud dojde ke kolizi, informace
o~kontaktech se uloží do seznamu k~pozdějšímu zpracování. Dvě tělesa mohou
mít více než jeden kontakt.

Tělesa se tranzisitvně shlukují podle kontaktů a vytvářejí tak ostrovy
(\textit{q3Island}), které se řeší každý nezávisle, ale kolizní
odezva těles v~rámci jednoho ostrovu se řeší společně.

Ke konci simulačního kroku se aktualizují pozice těles a~celý algoritmus se opakuje.

\subsection{Implementace}

Implementaci jsem umístil do souboru \texttt{qu3e/src/dynamics/q3ContactSolverOcl.cpp}.
Jistě úpravy bylo třeba udělat i~v~některých dalších souborech.
Většina změn se vyskytuje v~podmínce \texttt{\#ifdef WITH\_OCL}.
Zásadní změny v~knihovně lze zhlédnout v~mém repozitáři
\url{https://github.com/JOndra91/rigid-body-simulation} ve větvi \textit{qu3e}.
Několik dalších změn jsem pak provedl ve větvi \textit{master}, ale většinou
se nejednalo o~úpravu algoritmu, spíše to byly opravy chyb.

Velká část OpenCL kernelu je shodná s~metodou \texttt{q3ContactSolverCpu::Solve}.
Tato metoda řeší kolizní odezvu sekvenčně v~několika iteracích.
Ovšem vzhledem k~tomu, že některá tělesa sdílejí kontakty, není možné paralelně
zpracovat více kontaktů sdílející jedno těleso, protože by došlo
k~\textit{race condition}. V~tomto případě nepomohou ani atomické instrukce a~tak
je třeba naplánovat pro OpenCL výpočetní dávky. Implementace plánování
dávek se nachází v~metodě \texttt{q3ContactSolverOcl::PreSolve}.

V~ideálním případě by měla být velikost dávky co nejblíže násobku velikosti
skupiny (případně počtu výpočetních jednotech v~rámci jednoho multiprocesoru).
Toho bohužel nelze vždy dosáhnou, zvláště pak ke konci plánování, kdy zbývá jen
několik málo těles. Možným odlehlčením by bylo spočítat těchto pár těles na CPU
ale to by vedlo k~dalšímu kopírování dat mezi CPU a OpenCL bufferem.

Objekt \texttt{q3ContactSolver} řeší kolize pro každý objekt \texttt{q3Island}
zvlášť. Mezi objekty mezi ostrovy ale nejsou žádné závislosti a~bylo by je možné
řešit bez problému paralelně. To by teoreticky vedlo ke zvětšení dávek
a větší míře paralelizace. Proto by ovšem bylo třeba značně upravit algoritmus
použitý v~metodě \texttt{q3Scene::Step}. Na to jsem už ovšem neměl čas.

\subsection{Výsledky}

V~první fázi kdy padá celý shluk boxů je zrychlení nejznatelnější.
Zatímco pro 50 iteracích CPU algoritmus trvá v~průměru přibližně 2800ms.
OpenCL implementace vše vypočítá během 600ms na CPU a 700ms na GPU.
Nejsem si zcela jistý proč GPU implementace není rychlejší než CPU. Ale myslím
si, že to bude způsobeno velikostí dávek.

Po dopadu boxů se situace bohužel negativně změní. Zatímco CPU zvládne spočítat
rozpadlé boxy během 440ms. OpenCL CPU to trvá zhruba 980ms a GPU 1080ms.
To je způsobeno tím, že vznikne mnoho menších ostrovů. Velmi malé ostrovy
se řeší vždy na CPU. Větší ostrovy se pak počítají s~pomocí OpenCL ale bohužel
sekvenčně, což není ideální a~způsobuje to znatelné zpomalení.

\subsection{Použitý hardware}


Procesor: Intel Core i5 3210M Ivy Bridge (2 $\times$ 2,5 GHz + HyperThreading) \\
Grafická karta: nVidia GeForce GTX660M 2GB (384 jader)

\end{document}
% vim:set ft=tex expandtab enc=utf8:
